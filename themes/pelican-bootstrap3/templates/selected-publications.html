{% extends "base.html" %}
{% block title %}Selected Publications{% endblock %}

{% block extra_stylesheets %}
<style>
    .pub-filters {
        background: #f8f9fa;
        padding: 15px;
        margin-bottom: 25px;
        border-radius: 4px;
    }
    .pub-filters label {
        margin-right: 8px;
        font-weight: bold;
    }
    .pub-filters select {
        margin-right: 20px;
        padding: 5px 10px;
    }
    .pub-category {
        margin-bottom: 40px;
    }
    .pub-category h4 {
        border-bottom: 2px solid #2c3e50;
        padding-bottom: 10px;
        margin-bottom: 10px;
    }
    .category-description {
        color: #666;
        font-style: italic;
        margin-bottom: 20px;
    }
    .publications-list {
        list-style-type: decimal;
        padding-left: 25px;
    }
    .publications-list li {
        margin-bottom: 15px;
        padding: 10px;
        border-left: 3px solid transparent;
    }
    .publications-list li.highlight {
        border-left-color: #f39c12;
        background: #fffef5;
    }
    .pub-text {
        display: block;
        margin-bottom: 5px;
    }
    /* Style publication titles in teal (Flatly primary color) */
    .pub-text .pub-title {
        color: #18bc9c;
        font-weight: 500;
    }
    /* Style the pybtex-rendered arXiv/DOI links inside pub-text */
    .pub-text a {
        color: #888;
        font-size: 0.9em;
    }
    .pub-text a:hover {
        color: #EE9F43;
    }
    .pub-links {
        font-size: 0.85em;
        color: #888;
        font-style: italic;
    }
    .pub-links a {
        color: #888;
        margin-right: 3px;
    }
    .pub-links a:hover {
        color: #EE9F43;
    }
    .highlight-star {
        color: #f39c12;
        margin-right: 5px;
    }
    .hidden {
        display: none !important;
    }
    .pub-metrics-section {
        margin-bottom: 15px;
    }
    .metrics-profiles {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 15px;
    }
    .metrics-profiles a {
        font-size: 3em;
        color: #2c3e50;
    }
    .metrics-profiles a:hover {
        color: #EE9F43;
    }
    .metrics-boxes {
        display: flex;
        gap: 15px;
    }
    .metrics-box {
        flex: 1;
        background: #f8f9fa;
        padding: 15px 20px;
        border-radius: 4px;
        border-left: 4px solid #18bc9c;
    }
    .metrics-box-title {
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 10px;
        font-size: 0.95em;
    }
    .metrics-stats {
        display: flex;
        justify-content: space-around;
        gap: 15px;
    }
    .metric {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .metric-value {
        font-size: 1.3em;
        font-weight: bold;
        color: #2c3e50;
    }
    .metric-label {
        font-size: 0.75em;
        color: #666;
        text-transform: uppercase;
    }
    @media (max-width: 768px) {
        .metrics-boxes {
            flex-direction: column;
        }
    }
    .selected-pubs-header {
        margin-top: 10px;
        margin-bottom: 20px;
    }
    .pub-intro {
        color: #666;
        margin-bottom: 20px;
    }
    .section-divider {
        width: 50%;
        margin: 30px auto 10px auto;
        border-top: 2px solid #18bc9c;
    }
    /* Altmetric toggle and container */
    .altmetric-toggle {
        cursor: pointer;
        color: #888;
    }
    .altmetric-toggle:hover {
        color: #EE9F43;
    }
    .altmetric-container {
        display: none;
        margin-top: 10px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 4px;
    }
    .altmetric-container.show {
        display: block;
    }
    .pub-filters .btn-reset {
        padding: 3px 10px;
        font-size: 0.85em;
    }
    /* Sort toggle buttons */
    .sort-buttons {
        display: inline-block;
        margin-left: 20px;
    }
    .sort-buttons .btn {
        padding: 5px 12px;
        margin-right: 5px;
    }
    .sort-buttons .btn.active {
        background-color: #18bc9c;
        border-color: #18bc9c;
        color: white;
    }
    /* Flat list view for date/citation sorting */
    .flat-publications-list {
        list-style-type: decimal;
        padding-left: 25px;
    }
    .flat-publications-list li {
        margin-bottom: 15px;
        padding: 10px;
        border-left: 3px solid transparent;
    }
    .flat-publications-list li.highlight {
        border-left-color: #f39c12;
        background: #fffef5;
    }
    .pub-meta {
        font-size: 0.8em;
        color: #888;
        margin-left: 10px;
    }
</style>
<!-- Altmetric embed script -->
<script type='text/javascript' src='https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js'></script>
{% endblock %}

{% block content %}
<script type="text/javascript">
    function showBibtex(bibtex) {
        var formatted = bibtex.replace(/\\n/g, '\n');
        document.getElementById('bibtex-content').textContent = formatted;
        $('#bibtexModal').modal('show');
    }

    function copyBibtex() {
        var bibtexText = document.getElementById('bibtex-content').textContent;
        navigator.clipboard.writeText(bibtexText).then(function() {
            var btn = document.getElementById('copy-btn');
            btn.textContent = 'Copied!';
            btn.className = 'btn btn-success';
            setTimeout(function() {
                btn.textContent = 'Copy to Clipboard';
                btn.className = 'btn btn-primary';
            }, 2000);
        });
    }

    function filterPublications() {
        var catFilter = document.getElementById('filter-category').value;
        var yearFilter = document.getElementById('filter-year').value;
        var highlightFilter = document.getElementById('filter-highlight').checked;

        // Filter categories
        document.querySelectorAll('.pub-category').forEach(function(cat) {
            var catId = cat.getAttribute('data-category');
            if (catFilter && catId !== catFilter) {
                cat.classList.add('hidden');
            } else {
                cat.classList.remove('hidden');
            }
        });

        // Filter individual publications by year and highlight
        document.querySelectorAll('.publications-list li').forEach(function(pub) {
            var pubYear = pub.getAttribute('data-year');
            var isHighlight = pub.classList.contains('highlight');
            var hidden = false;

            if (yearFilter && pubYear !== yearFilter) {
                hidden = true;
            }
            if (highlightFilter && !isHighlight) {
                hidden = true;
            }

            if (hidden) {
                pub.classList.add('hidden');
            } else {
                pub.classList.remove('hidden');
            }
        });

        // Hide categories with no visible publications
        document.querySelectorAll('.pub-category').forEach(function(cat) {
            if (cat.classList.contains('hidden')) return;
            var visiblePubs = cat.querySelectorAll('.publications-list li:not(.hidden)');
            if (visiblePubs.length === 0) {
                cat.classList.add('hidden');
            }
        });
    }

    function resetFilters() {
        document.getElementById('filter-category').value = '';
        document.getElementById('filter-year').value = '';
        document.getElementById('filter-highlight').checked = false;
        filterPublications();
    }

    function toggleAltmetric(key) {
        var container = document.getElementById('altmetric-' + key);
        var link = document.getElementById('altmetric-link-' + key);
        if (container.classList.contains('show')) {
            container.classList.remove('show');
            link.textContent = 'show altmetrics';
        } else {
            container.classList.add('show');
            link.textContent = 'hide altmetrics';
            // Trigger altmetric to render if not already done
            if (typeof _altmetric_embed_init === 'function') {
                _altmetric_embed_init();
            }
        }
    }

    function toggleAllAltmetrics() {
        var checkbox = document.getElementById('toggle-all-altmetrics');
        var containers = document.querySelectorAll('.altmetric-container');
        var links = document.querySelectorAll('.altmetric-toggle');

        if (checkbox.checked) {
            containers.forEach(function(container) {
                container.classList.add('show');
            });
            links.forEach(function(link) {
                link.textContent = 'hide altmetrics';
            });
            // Trigger altmetric to render
            if (typeof _altmetric_embed_init === 'function') {
                _altmetric_embed_init();
            }
        } else {
            containers.forEach(function(container) {
                container.classList.remove('show');
            });
            links.forEach(function(link) {
                link.textContent = 'show altmetrics';
            });
        }
    }

    var currentSortMode = 'category';

    function setSortMode(mode) {
        currentSortMode = mode;

        // Update button states
        document.querySelectorAll('.sort-buttons .btn').forEach(function(btn) {
            btn.classList.remove('active');
        });
        document.getElementById('sort-' + mode).classList.add('active');

        // Show/hide appropriate views
        var categoryView = document.getElementById('category-view');
        var flatView = document.getElementById('flat-view');

        if (mode === 'category') {
            categoryView.style.display = 'block';
            flatView.style.display = 'none';
        } else {
            categoryView.style.display = 'none';
            flatView.style.display = 'block';
            sortFlatList(mode);
        }
    }

    function sortFlatList(mode) {
        var list = document.getElementById('flat-publications-list');
        var items = Array.from(list.querySelectorAll('li'));

        items.sort(function(a, b) {
            if (mode === 'date') {
                var yearA = parseInt(a.getAttribute('data-year')) || 0;
                var yearB = parseInt(b.getAttribute('data-year')) || 0;
                return yearB - yearA; // Most recent first
            } else if (mode === 'citations') {
                var citesA = parseInt(a.getAttribute('data-citations')) || 0;
                var citesB = parseInt(b.getAttribute('data-citations')) || 0;
                return citesB - citesA; // Most cited first
            }
            return 0;
        });

        // Re-append items in sorted order
        items.forEach(function(item) {
            list.appendChild(item);
        });

        // Re-number the list
        items.forEach(function(item, index) {
            item.setAttribute('value', index + 1);
        });
    }
</script>

<!-- Bootstrap Modal for BibTeX -->
<div class="modal fade" id="bibtexModal" tabindex="-1" role="dialog" aria-labelledby="bibtexModalLabel">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="bibtexModalLabel">BibTeX Entry</h4>
      </div>
      <div class="modal-body">
        <pre id="bibtex-content" style="white-space: pre-wrap; word-wrap: break-word; background: #f5f5f5; padding: 15px; border-radius: 4px;"></pre>
      </div>
      <div class="modal-footer">
        <button type="button" id="copy-btn" class="btn btn-primary" onclick="copyBibtex()">Copy to Clipboard</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<section id="content" class="body">
    <h1 class="entry-title">Publications</h1>

    <p class="pub-intro">This page includes links to my publication history, some aggregate bibliometrics, and some selected publications organized by research theme.</p>

    {% if ALL_PUBLICATION_METRICS or SMALL_AUTHOR_METRICS or PUBLICATION_PROFILES %}
    <div class="pub-metrics-section">
        {% if PUBLICATION_PROFILES %}
        <div class="metrics-profiles">
            {% for name, url, icon in PUBLICATION_PROFILES %}
            <a href="{{ url }}" target="_blank" title="{{ name }}"><i class="fa fa-{{ icon }}"></i></a>
            {% endfor %}
        </div>
        {% endif %}

        <div class="metrics-boxes">
            {% if ALL_PUBLICATION_METRICS %}
            <div class="metrics-box">
                <div class="metrics-box-title">All publications</div>
                <div class="metrics-stats">
                    {% if ALL_PUBLICATION_METRICS.total_publications %}
                    <span class="metric">
                        <span class="metric-value">{{ "{:,}".format(ALL_PUBLICATION_METRICS.total_publications) }}</span>
                        <span class="metric-label">Publications</span>
                    </span>
                    {% endif %}
                    {% if ALL_PUBLICATION_METRICS.total_citations %}
                    <span class="metric">
                        <span class="metric-value">{{ "{:,}".format(ALL_PUBLICATION_METRICS.total_citations) }}</span>
                        <span class="metric-label">Citations</span>
                    </span>
                    {% endif %}
                    {% if ALL_PUBLICATION_METRICS.h_index %}
                    <span class="metric">
                        <span class="metric-value">{{ ALL_PUBLICATION_METRICS.h_index }}</span>
                        <span class="metric-label">h-index</span>
                    </span>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {% if SMALL_AUTHOR_METRICS %}
            <div class="metrics-box">
                <div class="metrics-box-title">Publications with &lt;20 authors</div>
                <div class="metrics-stats">
                    {% if SMALL_AUTHOR_METRICS.total_publications %}
                    <span class="metric">
                        <span class="metric-value">{{ "{:,}".format(SMALL_AUTHOR_METRICS.total_publications) }}</span>
                        <span class="metric-label">Publications</span>
                    </span>
                    {% endif %}
                    {% if SMALL_AUTHOR_METRICS.total_citations %}
                    <span class="metric">
                        <span class="metric-value">{{ "{:,}".format(SMALL_AUTHOR_METRICS.total_citations) }}</span>
                        <span class="metric-label">Citations</span>
                    </span>
                    {% endif %}
                    {% if SMALL_AUTHOR_METRICS.h_index %}
                    <span class="metric">
                        <span class="metric-value">{{ SMALL_AUTHOR_METRICS.h_index }}</span>
                        <span class="metric-label">h-index</span>
                    </span>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <hr class="section-divider">
    <h3 class="selected-pubs-header">Selected Publications</h3>

    {% if selected_publications and selected_publications.categories %}
    <!-- Filters -->
    <div class="pub-filters">
        <div style="margin-bottom: 10px;">
            <label>Sort by:</label>
            <span class="sort-buttons">
                <button id="sort-category" class="btn btn-sm btn-default active" onclick="setSortMode('category')">Category</button>
                <button id="sort-date" class="btn btn-sm btn-default" onclick="setSortMode('date')">Date</button>
                <button id="sort-citations" class="btn btn-sm btn-default" onclick="setSortMode('citations')">Citations</button>
            </span>
        </div>

        <label for="filter-category">Category:</label>
        <select id="filter-category" onchange="filterPublications()">
            <option value="">All Categories</option>
            {% for cat in selected_publications.categories %}
            <option value="{{ cat.id }}">{{ cat.title }}</option>
            {% endfor %}
        </select>

        <label for="filter-year">Year:</label>
        <select id="filter-year" onchange="filterPublications()">
            <option value="">All Years</option>
            {% set years = [] %}
            {% for cat in selected_publications.categories %}
                {% for pub in cat.publications %}
                    {% if pub.year and pub.year not in years %}
                        {% set _ = years.append(pub.year) %}
                    {% endif %}
                {% endfor %}
            {% endfor %}
            {% for year in years|sort(reverse=true) %}
            <option value="{{ year }}">{{ year }}</option>
            {% endfor %}
        </select>

        <button class="btn btn-sm btn-default" onclick="resetFilters()">Reset</button>

        <div style="margin-top: 10px;">
            <label for="filter-highlight">
                <input type="checkbox" id="filter-highlight" onchange="filterPublications()">
                <span class="highlight-star">&#9733;</span> Highlights only
            </label>
            <label for="toggle-all-altmetrics" style="margin-left: 20px;">
                <input type="checkbox" id="toggle-all-altmetrics" onchange="toggleAllAltmetrics()">
                Show altmetrics
            </label>
        </div>
    </div>

    <!-- Category View (default) -->
    <div id="category-view">
    {% for cat in selected_publications.categories %}
    <section class="pub-category" id="cat-{{ cat.id }}" data-category="{{ cat.id }}">
        <h4>{{ cat.title }}</h4>
        {% if cat.description %}
        <p class="category-description">{{ cat.description }}</p>
        {% endif %}

        <ol class="publications-list">
        {% for pub in cat.publications %}
            <li class="{% if pub.highlight %}highlight{% endif %}"
                data-year="{{ pub.year }}"
                data-key="{{ pub.key }}">
                <span class="pub-text">
                    {% if pub.highlight %}<span class="highlight-star" title="Highlighted publication">&#9733;</span>{% endif %}
                    {{ pub.text }}
                </span>
                <span class="pub-links">
                    {% if pub.citations > 0 and pub.citation_url %}
                    [<a href="{{ pub.citation_url }}" target="_blank">{{ pub.citations }} citations</a>]
                    {% elif pub.citations > 0 %}
                    [{{ pub.citations }} citations]
                    {% endif %}
                    {% if pub.eprint %}
                    [<a href="https://arxiv.org/abs/{{ pub.eprint }}" target="_blank">arXiv</a>]
                    {% endif %}
                    {% if pub.doi %}
                    [<a href="https://doi.org/{{ pub.doi }}" target="_blank">DOI</a>]
                    {% endif %}
                    {% if pub.url and not pub.doi %}
                    [<a href="{{ pub.url }}" target="_blank">URL</a>]
                    {% endif %}
                    {% if pub.pdf %}
                    [<a href="{{ pub.pdf }}" target="_blank">PDF</a>]
                    {% endif %}
                    [<a href="javascript:void(0);" onclick="showBibtex(decodeURIComponent('{{ pub.bibtex|urlencode }}'));">BibTeX</a>]
                    {% if pub.doi or pub.eprint %}
                    [<a href="javascript:void(0);" id="altmetric-link-{{ pub.key }}" class="altmetric-toggle" onclick="toggleAltmetric('{{ pub.key }}');">show altmetrics</a>]
                    {% endif %}
                </span>
                {% if pub.doi or pub.eprint %}
                <div id="altmetric-{{ pub.key }}" class="altmetric-container">
                    <div class="altmetric-embed"
                         data-badge-type="donut"
                         data-badge-details="right"
                         data-hide-no-mentions="true"
                         {% if pub.doi %}data-doi="{{ pub.doi }}"{% endif %}
                         {% if pub.eprint and not pub.doi %}data-arxiv-id="{{ pub.eprint|replace('arXiv:', '') }}"{% endif %}>
                    </div>
                </div>
                {% endif %}
            </li>
        {% endfor %}
        </ol>
    </section>
    {% endfor %}
    </div>

    <!-- Flat View (for date/citation sorting) -->
    <div id="flat-view" style="display: none;">
        <ol id="flat-publications-list" class="flat-publications-list">
        {% for pub in selected_publications.all_publications %}
            <li class="{% if pub.highlight %}highlight{% endif %}"
                data-year="{{ pub.year }}"
                data-key="{{ pub.key }}"
                data-citations="{{ pub.citations }}"
                data-category="{{ pub.category_id }}">
                <span class="pub-text">
                    {% if pub.highlight %}<span class="highlight-star" title="Highlighted publication">&#9733;</span>{% endif %}
                    {{ pub.text }}
                    <span class="pub-meta">({{ pub.year }}{% if pub.citations > 0 %}, {{ pub.citations }} citations{% endif %})</span>
                </span>
                <span class="pub-links">
                    {% if pub.citations > 0 and pub.citation_url %}
                    [<a href="{{ pub.citation_url }}" target="_blank">{{ pub.citations }} citations</a>]
                    {% elif pub.citations > 0 %}
                    [{{ pub.citations }} citations]
                    {% endif %}
                    {% if pub.eprint %}
                    [<a href="https://arxiv.org/abs/{{ pub.eprint }}" target="_blank">arXiv</a>]
                    {% endif %}
                    {% if pub.doi %}
                    [<a href="https://doi.org/{{ pub.doi }}" target="_blank">DOI</a>]
                    {% endif %}
                    {% if pub.url and not pub.doi %}
                    [<a href="{{ pub.url }}" target="_blank">URL</a>]
                    {% endif %}
                    {% if pub.pdf %}
                    [<a href="{{ pub.pdf }}" target="_blank">PDF</a>]
                    {% endif %}
                    [<a href="javascript:void(0);" onclick="showBibtex(decodeURIComponent('{{ pub.bibtex|urlencode }}'));">BibTeX</a>]
                    {% if pub.doi or pub.eprint %}
                    [<a href="javascript:void(0);" id="altmetric-link-flat-{{ pub.key }}" class="altmetric-toggle" onclick="toggleAltmetric('flat-{{ pub.key }}');">show altmetrics</a>]
                    {% endif %}
                </span>
                {% if pub.doi or pub.eprint %}
                <div id="altmetric-flat-{{ pub.key }}" class="altmetric-container">
                    <div class="altmetric-embed"
                         data-badge-type="donut"
                         data-badge-details="right"
                         data-hide-no-mentions="true"
                         {% if pub.doi %}data-doi="{{ pub.doi }}"{% endif %}
                         {% if pub.eprint and not pub.doi %}data-arxiv-id="{{ pub.eprint|replace('arXiv:', '') }}"{% endif %}>
                    </div>
                </div>
                {% endif %}
            </li>
        {% endfor %}
        </ol>
    </div>

    {% else %}
    <p>No selected publications configured. Add a <code>SELECTED_PUBLICATIONS_SRC</code> setting pointing to a YAML file.</p>
    {% endif %}
</section>
{% endblock %}
